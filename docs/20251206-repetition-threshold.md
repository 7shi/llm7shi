# Repetition Detection Threshold Adjustment

This document describes the adjustment of repetition detection thresholds implemented on 2025-12-06, following the weighted whitespace detection enhancement.

## Background

### Original Design (2025-06-29)

The original repetition detection formula was designed to coordinate with whitespace detection:

- **Whitespace detection**: 128 characters threshold
- **Repetition detection**: Formula `total_len = 100 + (pattern_len - 1) × 8`
  - 1 character: 100 repetitions = 100 total characters
  - 5 characters: 26 repetitions ≈ 130 total characters
- **Design principle**: 5-character repetition patterns align with whitespace threshold (≈128)

This coordination ensured balanced detection sensitivity across different pattern types.

### Whitespace Enhancement (2025-12-06)

Whitespace detection was enhanced with weighted calculation:
- Threshold increased from 128 to 512 weighted units
- Weights: newlines (8×), tabs (4×), spaces (1×)
- Rationale: 128-character threshold caused false positives on legitimate output

## Problem Statement

The repetition detection threshold (100 characters for single-character patterns) became inconsistent with the new whitespace threshold (512 weighted units), breaking the original design coordination.

Additionally, production usage revealed that the 100-character threshold for single characters was too low, triggering false positives on legitimate repetitive content.

## Design Requirements

1. **Coordination with whitespace**: Maintain similar detection sensitivity
2. **Monotonic non-decreasing constraint**: Required for early termination optimization in `detect_repetition` (lines 52-54 of monitor.py)
3. **Reasonable long-pattern behavior**: Long patterns (50+ chars) should require ~20 repetitions, not excessive counts
4. **Simplicity**: Avoid complex formulas; use dynamic calculation or lookup table

## Algorithm Investigation

### Dynamic Base Algorithm

The core calculation follows this pattern:

```python
base = initial_value  # Starting point
prev_total = 0

for pattern_len in range(1, max_pattern):
    # Calculate repetitions needed
    required_reps = base // pattern_len
    total = required_reps * pattern_len

    # Ensure monotonic non-decreasing
    if total < prev_total:
        total = prev_total
        required_reps = ceil(total / pattern_len)
        total = required_reps * pattern_len

    # Update base for next iteration
    base = total
    prev_total = total
```

**Key insight**: The base value propagates through iterations, naturally creating a monotonically non-decreasing sequence without requiring explicit linear interpolation formulas.

### Monotonic Non-Decreasing (Not Strictly Increasing)

The early termination optimization in `detect_repetition` uses:

```python
if pattern_len * required_reps > len(text):
    break
```

This condition only requires that `pattern_len × required_reps` does not decrease. **Same values are acceptable** - strict increase is not necessary. This relaxation allows more natural value selection.

### Stabilization Behavior

With the dynamic base algorithm, required repetitions naturally stabilize at longer pattern lengths:

- Small initial base (e.g., 100): Stabilizes around 8-10 repetitions
- Medium initial base (e.g., 340): Stabilizes around 20 repetitions
- Large initial base (e.g., 480): Stabilizes around 23 repetitions

The stabilization point depends on the initial base value.

## Solution: Base 340, Threshold at 21 Characters

### Selected Parameters

```python
def _calculate_required_reps(pattern_len: int) -> int:
    # Base value for calculation
    base = 340

    # For patterns >= 21 characters, use fixed repetition count
    if pattern_len >= 21:
        return 20

    # For patterns < 21, use dynamic calculation
    # (implementation uses lookup table generated by dynamic base algorithm)
```

### Rationale

**Initial base = 340:**
- Produces 5-character threshold of 345 total characters (69 reps × 5)
- Balances between whitespace threshold (512) and practical repetition counts
- Stabilizes at 20 repetitions for longer patterns

**Fixed threshold at pattern_len >= 21:**
- Dynamic algorithm naturally reaches 20 repetitions at pattern_len = 21
- Beyond this point, 20 repetitions remain stable
- Provides clean cutoff point matching algorithm's natural behavior

**Fixed repetitions = 20:**
- 50-character pattern: 20 reps × 50 = 1000 total characters
- More reasonable than original 10 repetitions for long patterns
- Long patterns genuinely repeating 20+ times indicates problematic generation

### Comparison with Original Design

| Metric | Original (base=100) | New (base=340) | Change |
|--------|---------------------|----------------|--------|
| 1-char pattern | 100 reps = 100 total | 340 reps = 340 total | +240 total |
| 5-char pattern | 26 reps = 130 total | 69 reps = 345 total | +215 total |
| 21-char pattern | 10 reps = 210 total | 20 reps = 420 total | +210 total |
| 50-char pattern | 10 reps = 500 total | 20 reps = 1000 total | +500 total |
| Coordination | ~128 (whitespace) | ~345 vs 512 (whitespace) | Looser but balanced |

### Design Trade-offs

**Advantages:**
- Eliminates false positives on single-character repetitions (100 → 340)
- More reasonable repetition counts for long patterns (10 → 20)
- Natural stabilization from dynamic algorithm

**Considerations:**
- 5-character coordination is looser (345 vs 512) compared to original (130 vs 128)
- This is acceptable because:
  - Whitespace and repetition are different types of problems
  - Repetition detection is more tolerant by nature (content may legitimately repeat)
  - The ratio maintains similar detection philosophy

## Implementation

The implementation uses a pre-calculated lookup table generated by the dynamic base algorithm for pattern lengths 1-20, then switches to fixed value 20 for pattern lengths >= 21.

This approach:
- Maintains simplicity of the code
- Ensures exact monotonic non-decreasing behavior
- Avoids floating-point calculations at runtime
- Makes the threshold values explicit and verifiable

## Verification

The chosen values satisfy all requirements:

1. ✓ **Monotonic non-decreasing**: Verified by dynamic algorithm generation
2. ✓ **Early termination compatible**: Same-value transitions are acceptable
3. ✓ **Reasonable long-pattern behavior**: 50-char × 20 reps = 1000 total
4. ✓ **Reduced false positives**: 340 total for 1-char vs original 100
5. ✓ **Coordination maintained**: Detection sensitivities remain balanced

## Related Changes

This threshold adjustment accompanies the weighted whitespace detection enhancement documented in monitor.md. Both changes share the common goal of reducing false positives while maintaining effective detection of genuine problematic patterns.
